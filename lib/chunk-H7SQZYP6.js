import {a,d,e}from'./chunk-RPTR4L7Q.js';import {karinPathBase,logger,exists,mkdir,exec,readFile,buffer,base64,config}from'node-karin';import {Sequelize,literal,fn,col,Op,DataTypes}from'sequelize';import {spawn}from'node:child_process';import ce from'node:fs/promises';import N from'node:os';import C from'node:path';import K from'smol-toml';import Xe from'adm-zip';import ye from'axios-retry';import de from'node-karin/axios';var ie={};a(ie,{Cfg:()=>G,List:()=>H,Theme:()=>V});var G={};a(G,{helpCfg:()=>O});var O={title:`${d.Plugin_AliasName}\u5E2E\u52A9`,subTitle:d.Plugin_Name,columnCount:3,colWidth:265,theme:"all",style:{fontColor:"#d3bc8e",descColor:"#eee",contBgColor:"rgba(6, 21, 31, .5)",contBgBlur:3,headerBgColor:"rgba(6, 21, 31, .4)",rowBgColor1:"rgba(6, 21, 31, .2)"}};var H={};a(H,{helpList:()=>Ne});var Ne=[{group:"[]\u5185\u4E3A\u5FC5\u586B\u9879,{}\u5185\u4E3A\u53EF\u9009\u9879"},{group:"\u8868\u60C5\u547D\u4EE4",list:[{icon:161,title:"#\u67E0\u7CD6\u8868\u60C5\u5217\u8868",desc:"\u83B7\u53D6\u8868\u60C5\u5217\u8868"},{icon:90,title:"#\u67E0\u7CD6\u8868\u60C5\u641C\u7D22xx",desc:"\u641C\u6307\u5B9A\u7684\u8868\u60C5"},{icon:75,title:"#\u67E0\u7CD6\u8868\u60C5\u8BE6\u60C5xx",desc:"\u83B7\u53D6\u6307\u5B9A\u8868\u60C5\u8BE6\u60C5"},{icon:76,title:"#\u968F\u673A\u8868\u60C5",desc:"\u968F\u673A\u751F\u6210\u4E00\u4E2A\u8868\u60C5"},{icon:71,title:"xx",desc:"\u5982\u559C\u62A5xx (\u53C2\u6570\u4F7F\u7528#,\u591A\u4E2A\u53C2\u6570\u540C\u6837\u4F7F\u7528#, \u591A\u6BB5\u6587\u672C\u4F7F\u7528/, \u6307\u5B9A\u7528\u6237\u5934\u50CF\u4F7F\u7528@+qq\u53F7)"}]},{group:"\u670D\u52A1\u7AEF\u7BA1\u7406\u547D\u4EE4",auth:"master",list:[{icon:35,title:"#\u67E0\u7CD6\u8868\u60C5\u4E0B\u8F7D\u8868\u60C5\u670D\u52A1\u7AEF\u8D44\u6E90",desc:"\u4E0B\u8F7D\u8868\u60C5\u670D\u52A1\u7AEF\u8D44\u6E90"},{icon:35,title:"#\u67E0\u7CD6\u8868\u60C5\u66F4\u65B0\u8868\u60C5\u670D\u52A1\u7AEF\u8D44\u6E90",desc:"\u4E0B\u8F7D\u8868\u60C5\u670D\u52A1\u7AEF\u8D44\u6E90"},{icon:934,title:"#\u67E0\u7CD6\u8868\u60C5\u542F\u52A8\u8868\u60C5\u670D\u52A1\u7AEF",desc:"\u542F\u52A8\u8868\u60C5\u670D\u52A1\u7AEF"},{icon:34,title:"#\u67E0\u7CD6\u8868\u60C5\u5173\u95ED\u8868\u60C5\u670D\u52A1\u7AEF",desc:"\u542F\u52A8\u8868\u60C5\u670D\u52A1\u7AEF"},{icon:34,title:"#\u67E0\u7CD6\u8868\u60C5\u91CD\u542F\u8868\u60C5\u670D\u52A1\u7AEF",desc:"\u542F\u52A8\u8868\u60C5\u670D\u52A1\u7AEF"},{icon:34,title:"#\u67E0\u7CD6\u8868\u60C5\u670D\u52A1\u7AEF\u72B6\u6001",desc:"\u542F\u52A8\u8868\u60C5\u670D\u52A1\u7AEF"}]},{group:"\u7BA1\u7406\u547D\u4EE4\uFF0C\u4EC5\u4E3B\u4EBA\u53EF\u7528",auth:"master",list:[{icon:95,title:"#\u67E0\u7CD6\u8868\u60C5(\u63D2\u4EF6)\u66F4\u65B0",desc:"\u66F4\u65B0\u63D2\u4EF6\u672C\u4F53"},{icon:81,title:"#\u67E0\u7CD6\u8868\u60C5\u66F4\u65B0\u8868\u60C5\u8D44\u6E90",desc:"\u66F4\u65B0\u8868\u60C5\u8D44\u6E90"},{icon:85,title:"#\u67E0\u7CD6\u8868\u60C5\u8BBE\u7F6E",desc:"\u7BA1\u7406\u547D\u4EE4"}]}];var V={};a(V,{getThemeCfg:()=>ne,getThemeData:()=>je});var ne=()=>{let e=`${d.Plugin_Path}/resources/help/theme`,t=`${e}/main.webp`,r=`${e}/bg.webp`;return {main:t,bg:r,style:O.style}},je=e=>{let t=Object.assign({},e),r=Math.min(5,Math.max(parseInt(t?.colCount?.toString()??"3"),2)),a=Math.min(500,Math.max(100,parseInt(t?.colWidth?.toString()??"265"))),s=Math.min(2500,Math.max(800,r*a+30)),o=ne(),u=o.style??{},m=[`
    body { background-image: url(${o.bg}); width: ${s}px; }
    .container { background-image: url(${o.main}); width: ${s}px; }
    .help-table .td, .help-table .th { width: ${100/r}%; }
  `],n=function(...i){let g;return i.forEach(c=>{c!==void 0&&g===void 0&&(g=c);}),g},l=function(i,g,c,y,x){let f=n(u[c],e?.[c],y);x&&(f=x(f)),m.push(`${i} { ${g}: ${f}; }`);};return l(".help-title,.help-group","color","fontColor","#ceb78b"),l(".help-title,.help-group","text-shadow","fontShadow","none"),l(".help-desc","color","descColor","#eee"),l(".cont-box","background","contBgColor","rgba(43, 52, 61, 0.8)"),l(".cont-box","backdrop-filter","contBgBlur",3,i=>e?.bgBlur===false?"none":`blur(${i}px)`),l(".help-group","background","headerBgColor","rgba(34, 41, 51, .4)"),l(".help-table .tr:nth-child(odd)","background","rowBgColor1","rgba(34, 41, 51, .2)"),l(".help-table .tr:nth-child(even)","background","rowBgColor2","rgba(34, 41, 51, .4)"),{style:`<style>${m.join(`
`)}</style>`,colCount:r}};var Ee={};a(Ee,{make_meme:()=>zt});var k={};a(k,{base:()=>J,meme:()=>U,preset:()=>Q});var J={};a(J,{DataTypes:()=>DataTypes,Op:()=>Op,col:()=>col,fn:()=>fn,literal:()=>literal,sequelize:()=>S});var We=`${karinPathBase}/${d.Plugin_Config_Name}/data/`,S=new Sequelize({dialect:"sqlite",storage:`${We}/data.db`,logging:false});try{await S.authenticate(),logger.debug(logger.chalk.bold.cyan(`[${d.Plugin_AliasName}] \u6570\u636E\u5E93\u8FDE\u63A5\u6210\u529F`));}catch(e){logger.error(logger.chalk.bold.cyan(`[${d.Plugin_AliasName}] \u6570\u636E\u5E93\u8FDE\u63A5\u5931\u8D25: ${e}`));}var U={};a(U,{add:()=>De,get:()=>qe,getAll:()=>Oe,getByKeyWord:()=>Ke,getKeyWordsByAbout:()=>Le,getKeysByAbout:()=>ze,table:()=>T});var T=S.define("meme",{id:{type:DataTypes.INTEGER,allowNull:false,primaryKey:true,autoIncrement:true},key:{type:DataTypes.STRING,allowNull:false,unique:true},keyWords:{type:DataTypes.JSON,allowNull:false},min_texts:{type:DataTypes.INTEGER,allowNull:false},max_texts:{type:DataTypes.INTEGER,allowNull:false},min_images:{type:DataTypes.INTEGER,allowNull:false},max_images:{type:DataTypes.INTEGER,allowNull:false},default_texts:{type:DataTypes.JSON,allowNull:true},options:{type:DataTypes.JSON,allowNull:true},tags:{type:DataTypes.JSON,allowNull:true}},{freezeTableName:true,defaultScope:{raw:true}});await T.sync();async function De({key:e,keyWords:t,min_texts:r,max_texts:a,min_images:s,max_images:o,default_texts:u,options:m,tags:n},{force:l=false}={}){l&&await T.destroy({where:{key:e}});let i={key:e,keyWords:t,min_texts:r,max_texts:a,min_images:s,max_images:o,default_texts:u,options:m,tags:n};return await T.upsert(i)}async function qe(e){return await T.findOne({where:{key:e}})}async function ze(e){return await T.findAll({where:{key:{[Op.like]:`%${e}%`}}})}async function Ke(e){return await T.findOne({where:literal(`json_extract(keyWords, '$') LIKE '%"${e}"%'`)})}async function Le(e){return await T.findAll({where:literal(`json_extract(keyWords, '$') LIKE '%${e}%'`)})}async function Oe(){return await T.findAll()}var Q={};a(Q,{add:()=>Ge,get:()=>He,getAbout:()=>Ve,getAll:()=>Ue,getByKeyWord:()=>Fe,getByKeyWordAbout:()=>Je,remove:()=>Qe,table:()=>P});var P=S.define("preset",{id:{type:DataTypes.INTEGER,allowNull:false,primaryKey:true,autoIncrement:true},name:{type:DataTypes.STRING,allowNull:false},key:{type:DataTypes.STRING,allowNull:false},option_name:{type:DataTypes.STRING,allowNull:false},option_value:{type:DataTypes.STRING,allowNull:false}},{freezeTableName:true,defaultScope:{raw:true}});await P.sync();async function Ge({name:e,key:t,option_name:r,option_value:a},{force:s=false}={}){s&&await P.destroy({where:{key:t}}),e=String(e);let o={name:e,key:t,option_name:r,option_value:a};return await P.upsert(o)}async function He(e){return await P.findOne({where:{key:e}})}async function Ve(e){return await P.findAll({where:{key:e}})}async function Fe(e){return await P.findOne({where:{name:e}})}async function Je(e){return await P.findAll({where:{name:e}})}async function Ue(){return await P.findAll()}async function Qe(e){return !!await P.destroy({where:{key:e}})}var fe={};a(fe,{download_server:()=>me,download_server_resource:()=>rt,get_meme_server_meme_total:()=>nt,get_meme_server_memory:()=>ot,get_meme_server_name:()=>j,get_meme_server_path:()=>B,get_meme_server_pid:()=>X,get_meme_server_runtime:()=>st,get_meme_server_version:()=>at,init_server:()=>it,restart:()=>pt,start:()=>z,stop:()=>ge});function tt(e){let t=Math.floor(e/1e3),r=Math.floor(t/60),a=Math.floor(r/60),s=Math.floor(a/24),o=a%24,u=r%60,m=t%60,n="";return s>0&&(n+=`${s}\u5929`),o>0&&(n+=`${o}\u5C0F\u65F6`),u>0&&(n+=`${u}\u5206\u949F`),n+=`${m}\u79D2`,n}var q=C.join(karinPathBase,d.Plugin_Config_Name,"data","server");async function me(){try{let e$1;await exists(q)||await mkdir(q);let t=N.type(),r=N.arch();switch(t){case "Windows_NT":e$1="meme-generator-cli-windows-x86_64.zip";break;case "Linux":switch(r){case "x64":e$1="meme-generator-cli-linux-x86_64.zip";break;case "arm64":e$1="meme-generator-cli-linux-aarch64.zip";break;default:throw new Error("\u4E0D\u652F\u6301\u7684\u67B6\u6784")}break;case "Darwin":switch(r){case "x64":e$1="meme-generator-cli-macos-x86_64.zip";break;case "arm64":e$1="meme-generator-cli-macos-aarch64.zip";break;default:throw new Error("\u4E0D\u652F\u6301\u7684\u67B6\u6784")}break;default:throw new Error("\u4E0D\u652F\u6301\u7684\u64CD\u4F5C\u7CFB\u7EDF")}let a="https://github.com",s=await p.isAbroad()?a:`https://github.moeyy.xyz/${a}`,u=`${e.server.proxy_url?.trim()?`${e.server.proxy_url.replace(/\/+$/,"")}/${a}`:s}/MemeCrafters/meme-generator-rs/releases/latest/download/${e$1}`,m=await p.Request.get(u,null,null,"arraybuffer");logger.debug("\u4E0B\u8F7D\u8868\u60C5\u670D\u52A1\u7AEF\u6587\u4EF6\u6210\u529F"),logger.debug("\u5F00\u59CB\u89E3\u538B\u8868\u60C5\u670D\u52A1\u7AEF\u6587\u4EF6"),new Xe(m.data).extractAllTo(q,!0);}catch(e){throw logger.error(e),new Error("\u4E0B\u8F7D\u8868\u60C5\u670D\u52A1\u7AEF\u6587\u4EF6\u5931\u8D25:"+e.message)}}async function rt(){try{let e=C.join(`${B()}/${j()}`);if(!e)throw new Error("\u8868\u60C5\u670D\u52A1\u7AEF\u6587\u4EF6\u4E0D\u5B58\u5728");return new Promise((t,r)=>{let a=spawn(e,["download"],{stdio:"inherit"});a.on("error",s=>{logger.error(s),r(new Error("\u4E0B\u8F7D\u8868\u60C5\u670D\u52A1\u7AEF\u8D44\u6E90\u5931\u8D25"));}),a.on("close",s=>{s!==0?r(new Error("\u4E0B\u8F7D\u8868\u60C5\u670D\u52A1\u7AEF\u8D44\u6E90\u5931\u8D25")):(logger.info("\u4E0B\u8F7D\u8868\u60C5\u670D\u52A1\u7AEF\u8D44\u6E90\u6210\u529F"),t(!0));});})}catch(e){throw logger.error(e),new Error("\u66F4\u65B0\u8868\u60C5\u670D\u52A1\u7AEF\u8D44\u6E90\u5931\u8D25: "+e.message)}}function j(){let e;try{switch(N.type()){case "Windows_NT":e="meme.exe";break;case "Linux":case "Darwin":e="meme";break;default:throw new Error("\u4E0D\u652F\u6301\u7684\u64CD\u4F5C\u7CFB\u7EDF")}return e}catch(t){return logger.error(t),null}}function B(){return C.join(q)}async function at(){try{let e=await p.get_base_url();return (await p.Request.get(`${e}/meme/version`)).data}catch(e){return logger.error(e),null}}async function X(){try{let e=N.type(),t,r;switch(e){case "Windows_NT":t="wmic",r=["process","where",`name='${j()}'`,"get","ProcessId","/value"];break;case "Linux":case "Darwin":t="pgrep",r=["-f",j()??""];break;default:throw new Error("\u4E0D\u652F\u6301\u7684\u64CD\u4F5C\u7CFB\u7EDF")}let{status:a,stdout:s}=await exec(`${t} ${r.join(" ")}`);if(!a)throw new Error("\u83B7\u53D6\u8868\u60C5\u670D\u52A1\u7AEF\u8FDB\u7A0BID\u5931\u8D25");let o;if(e==="Windows_NT"){let u=s.match(/ProcessId=(\d+)/);if(!u)throw new Error("\u65E0\u6CD5\u83B7\u53D6\u8FDB\u7A0BID");o=u[1];}else o=s.trim().split(`
`)[0];if(!o)throw new Error("\u65E0\u6CD5\u83B7\u53D6\u8FDB\u7A0BID");return o}catch(e){return logger.error(e),"\u672A\u77E5"}}async function st(){try{let e=await X(),t=N.type(),r,a;switch(t){case "Windows_NT":r="wmic",a=["process","where",`processid=${e}`,"get","CreationDate","/value"];break;case "Linux":case "Darwin":r="ps",a=["-p",e,"-o","etime="];break;default:throw new Error("\u4E0D\u652F\u6301\u7684\u64CD\u4F5C\u7CFB\u7EDF")}let{status:s,stdout:o}=await exec(`${r} ${a.join(" ")}`);if(!s)throw new Error("\u83B7\u53D6\u8868\u60C5\u670D\u52A1\u7AEF\u8FD0\u884C\u65F6\u95F4\u5931\u8D25");let u;if(t==="Windows_NT"){let m=o.match(/CreationDate=(\d+)/);if(m){let n=m[1],l=parseInt(n.substring(0,4)),i=parseInt(n.substring(4,6))-1,g=parseInt(n.substring(6,8)),c=parseInt(n.substring(8,10)),y=parseInt(n.substring(10,12)),x=parseInt(n.substring(12,14)),f=new Date(l,i,g,c,y,x),A=new Date().getTime()-f.getTime();u=tt(A);}else throw new Error("\u65E0\u6CD5\u89E3\u6790WMIC\u8F93\u51FA\u7684\u521B\u5EFA\u65E5\u671F")}else {let m=o.trim();if(!m)throw new Error("\u65E0\u6CD5\u83B7\u53D6\u8FDB\u7A0B\u8FD0\u884C\u65F6\u95F4");u=m;}return u}catch(e){return logger.error(e),"\u672A\u77E5"}}async function ot(){try{let e=await X(),t=N.type(),r,a;switch(t){case "Windows_NT":r="wmic",a=["process","where",`processid=${e}`,"get","WorkingSetSize","/value"];break;case "Linux":case "Darwin":r="ps",a=["-p",process.pid.toString(),"-o","rss="];break;default:throw new Error("\u4E0D\u652F\u6301\u7684\u64CD\u4F5C\u7CFB\u7EDF")}let{status:s,stdout:o}=await exec(`${r} ${a.join(" ")}`,{log:!0});if(!s)throw new Error("\u83B7\u53D6\u8868\u60C5\u670D\u52A1\u7AEF\u5185\u5B58\u4F7F\u7528\u5931\u8D25");let u;if(t==="Windows_NT"){let m=o.match(/WorkingSetSize=(\d+)/);if(m){let n=m[1];u=parseInt(n)/(1024*1024);}else throw new Error("\u83B7\u53D6\u8868\u60C5\u670D\u52A1\u7AEF\u5185\u5B58\u4F7F\u7528\u5931\u8D25")}else u=parseInt(o.trim())/1024;return u%1===0?u.toFixed(0):u.toFixed(2)}catch(e){return logger.error(e),"\u672A\u77E5"}}async function nt(){try{let e=await p.get_base_url(),t=await p.Request.get(`${e}/meme/keys`);return console.log(t.data),t.data.length}catch(e){return logger.error(e),"\u672A\u77E5"}}async function it(e=2233){try{C.join(`${B()}/${j()}`)||await me();let r=C.join(N.homedir(),".meme_generator","resources");await exists(r)||logger.info("\u8868\u60C5\u670D\u52A1\u7AEF\u8D44\u6E90\u4E0D\u5B58\u5728\uFF0C\u8BF7\u7A0D\u540E\u4F7F\u7528[#\u67E0\u7CD6\u4E0B\u8F7D\u8868\u60C5\u670D\u52A1\u7AEF\u8D44\u6E90]\u547D\u4EE4\u4E0B\u8F7D"),await z(e);}catch(t){throw logger.error(t),new Error("\u521D\u59CB\u5316\u8868\u60C5\u670D\u52A1\u7AEF\u5931\u8D25:"+t.message)}}var $=null,pe={meme:{load_builtin_memes:true,load_external_memes:false,meme_disabled_list:[]},resource:{resource_url:"https://cdn.jsdelivr.net/gh/MemeCrafters/meme-generator-rs@",download_fonts:true},font:{use_local_fonts:true,default_font_families:["Noto Sans SC","Noto Color Emoji"]},encoder:{gif_max_frames:200,gif_encode_speed:1},api:{baidu_trans_appid:"",baidu_trans_apikey:""},server:{host:"0.0.0.0",port:2233}};async function z(e=2233){try{let t=C.join(N.homedir(),".meme_generator"),r=C.join(t,"config.toml");if(await exists(t)||await mkdir(r),!await exists(r)){let n=K.stringify(pe);await ce.writeFile(r,n);}let s=(await readFile(r))?.toString().trim()||K.stringify(pe),o=K.parse(s);o.server.port=e;let u=K.stringify(o);await ce.writeFile(r,u);let m=C.join(`${B()}/${j()}`);if(!m)throw new Error("\u672A\u627E\u5230\u8868\u60C5\u670D\u52A1\u7AEF\u6587\u4EF6");$=spawn(m,["run"],{stdio:"inherit"}),$.on("error",n=>{throw logger.error(n),new Error(`\u542F\u52A8\u670D\u52A1\u5668\u5931\u8D25: ${n.message}`)});}catch(t){throw logger.error(t),new Error(`\u542F\u52A8\u670D\u52A1\u5668\u5931\u8D25: ${t.message}`)}}async function ge(){try{if($)await new Promise((e,t)=>{$.on("exit",e),$.on("error",t),$.kill();}),$=null;else throw new Error("\u8868\u60C5\u670D\u52A1\u7AEF\u672A\u8FD0\u884C")}catch(e){throw logger.error(e),new Error(`\u505C\u6B62\u670D\u52A1\u5668\u5931\u8D25: ${e.message}`)}}async function pt(){try{$&&await ge(),await z();}catch(e){throw logger.error(e),new Error(`\u91CD\u542F\u670D\u52A1\u5668\u5931\u8D25: ${e.message}`)}}var p={};a(p,{Request:()=>I,add_meme:()=>ke,get_base_url:()=>ht,get_image:()=>kt,get_meme_all_keys:()=>Ie,get_meme_all_keywords:()=>At,get_meme_image:()=>se,get_meme_info:()=>Me,get_meme_info_by_keyword:()=>Pe,get_meme_key_by_keyword:()=>Tt,get_meme_keys_by_about:()=>$t,get_meme_keyword:()=>Nt,get_meme_keywords_by_about:()=>jt,get_meme_preview:()=>Rt,get_preset_all_about_keywords_by_key:()=>Et,get_preset_all_keys:()=>xe,get_preset_all_keywords:()=>It,get_preset_info:()=>Pt,get_preset_info_by_keyword:()=>ve,get_preset_key_by_keyword:()=>Mt,get_user_avatar:()=>_t,get_user_name:()=>bt,init:()=>vt,isAbroad:()=>wt,make_meme:()=>Ct,preset:()=>xt,update_meme:()=>_e,update_preset:()=>be,upload_image:()=>St});var ee=class{axiosInstance;constructor(){this.axiosInstance=de.create({timeout:e.server.timeout*1e3,headers:{"User-Agent":`${d.Plugin_Name}/v${d.Plugin_Version}`}}),ye(this.axiosInstance,{retries:e.server.retry,retryDelay:()=>0,shouldResetTimeout:true,retryCondition:t=>t.response?t.response.status===500:ye.isNetworkOrIdempotentRequestError(t)});}async request(t,r,a,s,o,u="json"){let m={params:s,headers:o??void 0,responseType:u};try{let n;switch(t.toLowerCase()){case "get":n=await this.axiosInstance.get(r,m);break;case "post":n=await this.axiosInstance.post(r,a,m);break;case "head":return n=await this.axiosInstance.head(r,m),{success:n.status>=200&&n.status<500,statusCode:n.status,data:Object.fromEntries(Object.entries(n.headers).map(([l,i])=>[l.toLowerCase(),i])),msg:n.status>=200&&n.status<500?"\u8BF7\u6C42\u6210\u529F":"\u8BF7\u6C42\u5931\u8D25"};default:throw new Error("\u6682\u4E0D\u652F\u6301\u8BE5\u8BF7\u6C42\u65B9\u6CD5")}return {success:n.status>=200&&n.status<500,statusCode:n.status,data:n.data,msg:n.status>=200&&n.status<500?"\u8BF7\u6C42\u6210\u529F":"\u8BF7\u6C42\u5931\u8D25"}}catch(n){let l=n,i=this.handleError(l);return {success:false,statusCode:l.response?.status??500,data:null,msg:i}}}async get(t,r,a,s="json"){return this.request("get",t,null,r,a,s)}async head(t,r,a,s="json"){return this.request("head",t,null,r,a,s)}async post(t,r,a,s="json"){return this.request("post",t,r,null,a,s)}handleError(t){if(de.isAxiosError(t)){let r;return t.response?.data?Buffer.isBuffer(t.response.data)?r=t.response.data.toString("utf-8"):typeof t.response.data=="string"?r=t.response.data:r=JSON.stringify(t.response.data):t.response?.statusText?r=t.response.statusText.toString():t.message?r=t.message.toString():r="\u672A\u77E5\u9519\u8BEF",r}else return t}},I=new ee;async function ht(){try{let e$1;switch(e.server.mode){case 0:e$1=e.server.url.replace(/\/+$/,"")||"https://meme.wuliya.cn";break;case 1:{let t=C.join(N.homedir(),".meme_generator","resources");if(!await exists(t))throw new Error("\u8BF7\u5148\u4F7F\u7528[#\u67E0\u7CD6\u8868\u60C5\u4E0B\u8F7D\u8868\u60C5\u670D\u52A1\u7AEF\u8D44\u6E90]");e$1=`http://127.0.0.1:${e.server.port}`;break}default:throw new Error("\u8BF7\u68C0\u67E5\u670D\u52A1\u5668\u6A21\u5F0F")}return Promise.resolve(e$1)}catch(e){throw logger.error(e),new Error(e.message)}}async function wt(){let e=["https://blog.cloudflare.com/cdn-cgi/trace","https://developers.cloudflare.com/cdn-cgi/trace"];try{let a=(await Promise.all(e.map(o=>I.get(o,null,null,"text")))).map(o=>o.data).filter(Boolean).flatMap(o=>o.split(`
`).filter(u=>u)).map(o=>o.split("="));return Object.fromEntries(a).loc!=="CN"}catch(t){throw new Error(`\u83B7\u53D6 IP \u6240\u5728\u5730\u533A\u51FA\u9519: ${t.message}`)}}async function _t(e$1,t,r="url"){try{if(!e$1)throw new Error("\u6D88\u606F\u4E8B\u4EF6\u4E0D\u80FD\u4E3A\u7A7A");if(!t)throw new Error("\u7528\u6237ID\u4E0D\u80FD\u4E3A\u7A7A");let a=C.join(karinPathBase,d.Plugin_Config_Name,"data","avatar"),s=C.join(a,`${t}.png`).replace(/\\/g,"/");if(e.meme.cache&&await exists(s)){let l=(await I.head(await e$1.bot.getAvatarUrl(t))).data["last-modified"],i=await ce.stat(s);if(new Date(l)<=i.mtime)switch(r){case "base64":{let g=await readFile(s);if(!g)throw new Error(`\u901A\u8FC7\u7F13\u5B58\u83B7\u53D6\u7528\u6237\u5934\u50CF\u5931\u8D25: ${t}`);return {userId:t,avatar:g.toString("base64")}}case "url":default:return {userId:t,avatar:s}}}let o=await e$1.bot.getAvatarUrl(t);if(!o)throw new Error(`\u83B7\u53D6\u7528\u6237\u5934\u50CF\u5931\u8D25: ${t}`);e.meme.cache&&!await exists(a)&&await mkdir(a);let m=(await I.get(o,{},{},"arraybuffer")).data;switch(e.meme.cache&&await ce.writeFile(s,m),r){case "base64":return {userId:t,avatar:m.toString("base64")};case "url":default:return {userId:t,avatar:e.meme.cache?s:o}}}catch(a){return logger.error(a),null}}async function bt(e,t){try{let r=null,a;if(e.isGroup?(a=await e.bot.getGroupMemberInfo(e.groupId,t),r=a.card?.trim()||a.nick?.trim()||null):e.isPrivate?(a=await e.bot.getStrangerInfo(t),r=a.nick.trim()??null):r=e.sender.nick.trim()??null,!r)throw new Error("\u83B7\u53D6\u7528\u6237\u6635\u79F0\u5931\u8D25");return r}catch(r){return logger.error(`\u83B7\u53D6\u7528\u6237\u6635\u79F0\u5931\u8D25: ${r}`),"\u672A\u77E5"}}async function kt(e,t="url"){let r=e.elements.filter(l=>l.type==="image").map(l=>({userId:e.sender.userId,file:l.file})),a=[],s=[],o=null,u=null;if(e.replyId?u=(await e.bot.getMsg(e.contact,e.replyId)).messageId:u=e.elements.find(l=>l.type==="reply")?.messageId,u&&(o=(await e.bot.getHistoryMsg(e.contact,u,2))?.[0]??null),o&&(s=(Array.isArray(o)?o:[o]).flatMap(({elements:i,sender:g})=>i.filter(c=>c.type==="image").map(c=>({userId:g.userId,file:c.file})))),s.length>0)for(let l of s)if(t==="url")a.push(Promise.resolve({userId:l.userId,image:l.file.toString()}));else {let i=await buffer(l.file);a.push(Promise.resolve({userId:l.userId,image:i.toString("base64")}));}if(r.length>0){let l=r.map(async i=>{if(t==="url")return {userId:i.userId,image:i.file.toString()};{let g=await buffer(i.file);return {userId:i.userId,image:g.toString("base64")}}});a.push(...l);}return (await Promise.allSettled(a)).filter(l=>l.status==="fulfilled"&&!!l.value).map(l=>l.value)}var xt=[{name:"\u5FC3\u5948\u8BF4",key:"ba_say",option_name:"character",option_value:"kokona"},{name:"\u7231\u4E3D\u4E1D\u8BF4",key:"ba_say",option_name:"character",option_value:"arisu"},{name:"\u6CC9\u5948\u8BF4",key:"ba_say",option_name:"character",option_value:"izuna"},{name:"key\u8BF4",key:"ba_say",option_name:"character",option_value:"key"},{name:"\u739B\u4E3D\u8BF4",key:"ba_say",option_name:"character",option_value:"mari"},{name:"\u6FD1\u540D\u8BF4",key:"ba_say",option_name:"character",option_value:"sena"},{name:"\u4F18\u9999\u8BF4",key:"ba_say",option_name:"character",option_value:"yuuka"},{name:"\u516B\u91CD\u795E\u5B50\u5403",key:"genshin_eat",option_name:"character",option_value:"nilou"},{name:"\u795E\u5B50\u5403",key:"genshin_eat",option_name:"character",option_value:"nilou"},{name:"\u516B\u91CD\u5403",key:"genshin_eat",option_name:"character",option_value:"nilou"},{name:"\u80E1\u6843\u5403",key:"genshin_eat",option_name:"character",option_value:"hutao"},{name:"\u59AE\u9732\u5403",key:"genshin_eat",option_name:"character",option_value:"nilou"},{name:"\u53EF\u8389\u5403",key:"genshin_eat",option_name:"character",option_value:"klee"},{name:"\u523B\u6674\u5403",key:"genshin_eat",option_name:"character",option_value:"keqing"},{name:"\u949F\u79BB\u5403",key:"genshin_eat",option_name:"character",option_value:"zhongli"},{name:"\u7231\u8389\u8BF4",key:"pjsk",option_name:"character",option_value:"airi"},{name:"\u5F70\u4EBA\u8BF4",key:"pjsk",option_name:"character",option_value:"akito"},{name:"\u674F\u8BF4",key:"pjsk",option_name:"character",option_value:"an"},{name:"\u68A6\u8BF4",key:"pjsk",option_name:"character",option_value:"emu"},{name:"\u7ED8\u540D\u8BF4",key:"pjsk",option_name:"character",option_value:"ena"},{name:"\u9065\u8BF4",key:"pjsk",option_name:"character",option_value:"haruka"},{name:"\u7A57\u6CE2\u8BF4",key:"pjsk",option_name:"character",option_value:"honami"},{name:"\u4E00\u6B4C\u8BF4",key:"pjsk",option_name:"character",option_value:"ichika"},{name:"KAITO\u8BF4",key:"pjsk",option_name:"character",option_value:"kaito"},{name:"\u594F\u8BF4",key:"pjsk",option_name:"character",option_value:"kanade"},{name:"\u5FC3\u7FBD\u8BF4",key:"pjsk",option_name:"character",option_value:"kohane"},{name:"\u8FDE\u8BF4",key:"pjsk",option_name:"character",option_value:"len"},{name:"\u6D41\u6B4C\u8BF4",key:"pjsk",option_name:"character",option_value:"luka"},{name:"\u771F\u51AC\u8BF4",key:"pjsk",option_name:"character",option_value:"mafuyu"},{name:"MEIKO\u8BF4",key:"pjsk",option_name:"character",option_value:"meiko"},{name:"\u521D\u97F3\u672A\u6765\u8BF4",key:"pjsk",option_name:"character",option_value:"miku"},{name:"\u5B9E\u4E43\u7406\u8BF4",key:"pjsk",option_name:"character",option_value:"minori"},{name:"\u745E\u5E0C\u8BF4",key:"pjsk",option_name:"character",option_value:"mizuki"},{name:"\u5B81\u5B81\u8BF4",key:"pjsk",option_name:"character",option_value:"nene"},{name:"\u94C3\u8BF4",key:"pjsk",option_name:"character",option_value:"rin"},{name:"\u7C7B\u8BF4",key:"pjsk",option_name:"character",option_value:"rui"},{name:"\u54B2\u5E0C\u8BF4",key:"pjsk",option_name:"character",option_value:"saki"},{name:"\u5FD7\u6B65\u8BF4",key:"pjsk",option_name:"character",option_value:"shiho"},{name:"\u96EB\u8BF4",key:"pjsk",option_name:"character",option_value:"shizuku"},{name:"\u51AC\u5F25\u8BF4",key:"pjsk",option_name:"character",option_value:"touya"},{name:"\u53F8\u8BF4",key:"pjsk",option_name:"character",option_value:"tsukasa"}];async function vt(){await _e(),await be();}async function _e(e=false){try{let t=await Ie();if(t&&t.length>0&&!e)return;let r=await p.get_base_url(),a=await I.get(`${r}/meme/infos`);if(!a.success)throw new Error(a.msg);a.data&&Array.isArray(a.data)&&await Promise.all(a.data.map(s=>{let{key:o,keywords:u,params:{min_texts:m,max_texts:n,min_images:l,max_images:i,default_texts:g,options:c},tags:y}=s;return ke({key:o,keyWords:u?.length?u:null,min_texts:m,max_texts:n,min_images:l,max_images:i,default_texts:g?.length?g:null,options:c?.length?c:null,tags:y?.length?y:null},{force:e})}));}catch(t){logger.error(`\u521D\u59CB\u5316\u8868\u60C5\u6570\u636E\u5931\u8D25: ${t}`);}}async function be(e=false){try{let t=await xe();if(t&&t.length>0&&!e)return;let r=p.preset;await Promise.all(r.map(async a=>{await k.preset.add({name:a.name,key:a.key,option_name:a.option_name,option_value:a.option_value},{force:e});}));}catch(t){logger.error(`\u521D\u59CB\u5316\u9884\u8BBE\u6570\u636E\u5931\u8D25: ${t}`);}}async function ke({key:e,keyWords:t,min_texts:r,max_texts:a,min_images:s,max_images:o,default_texts:u,options:m,tags:n},{force:l=false}){let i={key:e,keyWords:t,min_texts:r,max_texts:a,min_images:s,max_images:o,default_texts:u,options:m,tags:n};return await k.meme.add(i,{force:l})}async function xe(){return (await k.preset.getAll()).map(t=>t.key).flat()??null}async function It(){return (await k.preset.getAll()).map(t=>t.name).flat()??null}async function Mt(e){let t=await ve(e);return t?t.key:null}async function Pt(e){return await k.preset.get(e)}async function ve(e){return await k.preset.getByKeyWord(e)}async function Et(e){return (await k.preset.getAbout(e)).map(r=>r.name).flat()??null}async function Ie(){return (await k.meme.getAll()).map(t=>t.key).flat()??null}async function Tt(e){let t=await Pe(e);return t?t.key:null}async function $t(e){return (await k.meme.getKeysByAbout(e)).map(r=>r.key).flat()??null}async function At(){return (await k.meme.getAll()).map(t=>JSON.parse(String(t.keyWords))).flat()??null}async function Nt(e){let t=await Me(e);return t?JSON.parse(String(t.keyWords)):null}async function jt(e){return (await k.meme.getKeyWordsByAbout(e)).map(r=>JSON.parse(String(r.keyWords))).flat()??null}async function Me(e){return await k.meme.get(e)??null}async function Pe(e){return await k.meme.getByKeyWord(e)??null}async function se(e){try{let t=await p.get_base_url(),r=await I.get(`${t}/image/${e}`,{},{},"arraybuffer");if(!r.success)throw new Error("\u83B7\u53D6\u56FE\u7247\u5931\u8D25");return r.data}catch(t){throw logger.error(t),new Error(t.message)}}async function St(e,t="url",r){try{let a=await p.get_base_url(),s;switch(t){case "url":s={type:"url",url:e,...r&&{headers:r}};break;case "path":s={type:"path",path:e};break;case "data":s={type:"data",data:Buffer.isBuffer(e)?e.toString("base64"):e};break}let o=await I.post(`${a}/image/upload`,s,{},"json");if(!o.success)throw new Error("\u56FE\u7247\u4E0A\u4F20\u5931\u8D25");return o.data.image_id}catch(a){throw logger.error(a),new Error(a.message)}}async function Rt(e){try{let t=await p.get_base_url(),r=await I.get(`${t}/memes/${e}/preview`);if(!r.success)throw new Error(r.msg);return await se(r.data.image_id)}catch(t){throw logger.error(t),new Error(t.message)}}async function Ct(e,t){try{let r=await p.get_base_url(),a=await I.post(`${r}/memes/${e}`,t,{},"json");if(!a.success)throw new Error(a.msg);let s=await se(a.data.image_id);if(!s)throw new Error("\u83B7\u53D6\u56FE\u7247\u5931\u8D25");return s}catch(r){throw logger.error(r),new Error(r.message)}}async function Te(e$1,t,r,a,s,o,u,m){let n=[],l=await p.get_image(e$1,"url"),i=[],g=l.map(async c=>{let[y,x]=await Promise.all([p.upload_image(c.image,"url"),p.get_user_name(e$1,c.userId)]);return {name:x,id:y}});if(n=await Promise.all(g),s.length>0){let c=await p.get_user_avatar(e$1,s[0],"url");if(c){let y;e.meme.enable?y=await p.upload_image(c.avatar,"path"):y=await p.upload_image(c.avatar,"url"),i.push({name:await p.get_user_name(e$1,c.userId),id:y});}}if(l.length===0&&o){let c=await p.get_user_avatar(e$1,o,"url");if(c){let y;e.meme.cache?y=await p.upload_image(c.avatar,"path"):y=await p.upload_image(c.avatar,"url"),i.push({name:await p.get_user_name(e$1,c.userId),id:y});}}if(r===1&&l.length===0){let c=await p.get_user_avatar(e$1,e$1.userId,"url");if(c){let y;e.meme.cache?y=await p.upload_image(c.avatar,"path"):y=await p.upload_image(c.avatar,"url"),i.push({name:await p.get_user_name(e$1,c.userId),id:y});}}if(n.length+i.length<r){let c=await p.get_user_avatar(e$1,e$1.userId,"url");if(c){let y;e.meme.enable?y=await p.upload_image(c.avatar,"path"):y=await p.upload_image(c.avatar,"url"),i.unshift({name:await p.get_user_name(e$1,c.userId),id:y});}}if(e.protect.enable){let c=e.protect.list;if(c.length>0&&(await Promise.all(c.map(async x=>await p.get_meme_key_by_keyword(x)??x))).includes(t)){let x=[...s,...o?[o]:[]];if(x.length>0){let f=config.master(),E=o??(x.length===1?x[0]:x[1]);e.protect.master?!e$1.isMaster&&f.includes(E)&&i.reverse():e.protect.userEnable&&(Array.isArray(e.protect.user)?e.protect.user.map(String):[String(e.protect.user)]).includes(E)&&i.reverse();}}}return n=[...i,...n].slice(0,a),m.images=n,n.length<r?{success:false,message:r===a?`\u8BE5\u8868\u60C5\u9700\u8981${r}\u5F20\u56FE\u7247`:`\u8BE5\u8868\u60C5\u9700\u8981 ${r} ~ ${a}\u5F20\u56FE\u7247`}:{success:true,text:u}}async function $e(e,t,r,a,s){let o={},u=r.match(/#(\S+)\s+([^#]+)/g),m=[];if(s){let i=await p.get_preset_info(t);if(!i)return {success:false,message:"\u83B7\u53D6\u9884\u8BBE\u4FE1\u606F\u5931\u8D25"};m.push({name:i.option_name,value:i.option_value});}else if(u)for(let i of u){let[,g,c]=i.match(/#(\S+)\s+([^#]+)/)??null;g&&c&&m.push({name:g.trim(),value:c.trim()});}let n=(await p.get_meme_info(t))?.options??null;if(!n)return {success:false,message:"\u83B7\u53D6\u9009\u9879\u4FE1\u606F\u5931\u8D25"};let l=Array.isArray(n)?n:JSON.parse(n);for(let i of m){let g=l.find(y=>y.name===i.name);if(!g)return {success:false,message:`\u8BE5\u8868\u60C5\u4E0D\u652F\u6301\u53C2\u6570\uFF1A${i.name}`};let c=Wt(i,g);if(!c.success)return {success:false,message:c.message};o[i.name]=c.value;}return a.options=o,{success:true,text:r.replace(/#(\S+)\s+([^#]+)/g,"").trim()}}function Wt(e,t){let r;switch(t.type){case "boolean":{let a=e.value.toLowerCase();if(["true","\u771F","\u662F","yes","1"].includes(a))r=true;else if(["false","\u5047","\u5426","no","0"].includes(a))r=false;else return {success:false,message:`\u53C2\u6570 ${e.name} \u9700\u8981\u662F\u5E03\u5C14\u503C`};return {success:true,value:r}}case "integer":{let a=parseInt(e.value);return isNaN(a)?{success:false,message:`\u53C2\u6570 ${e.name} \u9700\u8981\u662F\u6574\u6570`}:t.minimum!==null&&a<t.minimum?{success:false,message:`\u53C2\u6570 ${e.name} \u4E0D\u80FD\u5C0F\u4E8E ${t.minimum}`}:t.maximum!==null&&a>t.maximum?{success:false,message:`\u53C2\u6570 ${e.name} \u4E0D\u80FD\u5927\u4E8E ${t.maximum}`}:{success:true,value:a}}case "float":{let a=parseFloat(e.value);return isNaN(a)?{success:false,message:`\u53C2\u6570 ${e.name} \u9700\u8981\u662F\u6570\u5B57`}:t.minimum!==null&&a<t.minimum?{success:false,message:`\u53C2\u6570 ${e.name} \u4E0D\u80FD\u5C0F\u4E8E ${t.minimum}`}:t.maximum!==null&&a>t.maximum?{success:false,message:`\u53C2\u6570 ${e.name} \u4E0D\u80FD\u5927\u4E8E ${t.maximum}`}:{success:true,value:a}}case "string":return r=e.value,t.choices&&!t.choices.includes(r)?{success:false,message:`\u53C2\u6570 ${e.name} \u7684\u503C\u5FC5\u987B\u662F: ${t.choices.join(", ")} \u4E4B\u4E00`}:{success:true,value:r};default:return {success:false,message:`\u4E0D\u652F\u6301\u7684\u53C2\u6570\u7C7B\u578B\uFF1A${t.type}`}}}async function Ae(e$1,t,r,a,s,o,u){let m=[];if(s){let i=s.split("/").map(g=>g.trim());for(let g of i)g&&m.push(g);}if(m.length===0&&e.meme.userName)if(o.length>=1){let i=o[0],g=await p.get_user_name(e$1,i);m.push(g);}else {let i=await p.get_user_name(e$1,e$1.userId);m.push(i);}let l=(await p.get_meme_info(t))?.default_texts??null;if(m.length<r&&l)for(;m.length<r;){let i=Math.floor(Math.random()*l.length);m.push(l[i]);}return u.texts=m,m.length<r?{success:false,message:r===a?`\u8BE5\u8868\u60C5\u9700\u8981${r}\u4E2A\u6587\u672C`:`\u8BE5\u8868\u60C5\u9700\u8981 ${r} ~ ${a}\u4E2A\u6587\u672C`}:{success:true,texts:s}}async function zt(e,t,r,a,s,o,u,m,n){try{let i=await(async f=>{let E=null,A=null;return f.replyId?A=(await f.bot.getMsg(f.contact,f.replyId)).messageId??null:A=f.elements.find(oe=>oe.type==="reply")?.messageId??null,A&&(E=(await f.bot.getHistoryMsg(f.contact,A,2))?.[0]??null),E?(Array.isArray(E)?E:[E])[0].sender.userId.toString():null})(e),g=[...new Set([...e.elements.filter(f=>f?.type==="at").map(f=>f?.targetId?.toString()??""),...[...m?.matchAll(/@\s*(\d+)/g)??[]].map(f=>f[1]??"")])].filter(f=>f&&f!==i),c={images:[],texts:[],options:{}};if(u){let f=await $e(e,t,m,c,n);if(!f.success)throw new Error(f.message);m=f.text;}if(a>0){let f=await Ae(e,t,r,a,m,g,c);if(!f.success)throw new Error(f.message)}if(o>0){let f=await Te(e,t,s,o,g,i,m,c);if(!f.success)throw new Error(f.message)}let y=await p.make_meme(t,c);return `base64://${await base64(y)}`}catch(l){throw logger.error(l),new Error(l.message)}}
export{ie as a,Ee as b,fe as c,p as d};